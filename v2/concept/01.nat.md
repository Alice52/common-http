[toc]

# 网络链接

![avatar](/static/image/concept/concept-vat.png)

## nat: 将一堆内网设备隐藏在某个(些)公网 IP 后连接到网络

1. 定义

   - Network Address Translation(网络地址转换): 允许一个整体机构以一个公用 IP 地址出现在 Internet 上
   - 本质: 把内部私有网络地址翻译成合法网络 IP 地址的技术
   - 优势: 接入公网简单(无需配置 IP 地址,子网掩码, 网关等信息), _自动生成配置_, 使用宿主机的 IP 接入公网

   ![avatar](/static/image/concept/concept-nat-net.png)

2. 目的: IPv4 数目一定, 为了让所有机器都能联网的技术(将内网 IP 转换成对外的 IP, 充当了网关的作用)
3. 分类

   - 静态 NAT(Static NAT): 内部网络中的每个主机都被永久映射成外部网络中的某个合法的地址
   - 动态地址 NAT(Pooled NAT): 在外部网络中定义了一系列的合法地址, 采用动态分配的方法映射到内部网络
   - 网络地址端口转换 NAPT(Port－Level NAT)
     1. 把内部地址映射到外部网络的一个 IP 地址的不同端口(由 NAT 设备选定)上
     2. 将中小型的网络隐藏在一个合法的 IP 地址后面

4. 产品: 路由器(网关)

   - 连接公网
     1. 内网出: 内网发出的包都将经过路由器(公网 IP), 被其修改源 IP 都改为公网 IP(且随机映射一个对外端口)
     2. 内网入: 应答回到路由器, 其会根据此前的映射关系, 将目标 IP 和 PORT 改为原先发送请求的内网用户的 IP 和 PORT
     3. 结论: 这样对于内网用户来说是感知不到路由器的存在的, 大家共用路由器的对外 IP 访问公网
   - 连接局域网: 路由器基于 DHCP 分配, 内网用户可以通信, **虚拟系统也就无法和本局域网中的其它真实主机进行通讯(同一宿主机下的多个虚拟机可以通信)**
     1. DHCP(动态主机配置协议): 局域网的网络协议
     2. 定义: 由服务器控制一段 IP 地址范围, 客户机登录服务器时就可以自动获得服务器分配的 IP 地址和子网掩码

5. 宿主机应该能 ping 通虚拟机的

   - [Ping 不通的原因](https://www.ngui.cc/el/2842864.html): VMnet8 网络适配器 IP 设置不对, 与虚拟机 IP 没在同一个网段

## 桥接模式: 通过转发包将虚拟机通过桥(宿主机)连接到网络

1. 必须**手工**为虚拟系统配置 IP 地址、子网掩码、网关, 并且还要和宿主机器处于同一网段, 这样虚拟系统才干和宿主机器进行通信

   - 优势: 有 dhcp 分配的局域网 IP(消耗局域网 IP 地址), 虚拟机系统间及与非宿主机的其他局域网设备可通信, 可连接公网

2. 目的

   - 桥接更加适合于虚拟机对外提供服务(可以向路由器申请 dhcp 得到局域网 IP)
   - 可以连接公网

3. 分类

   - 正常桥接模式
   - HOST-ONLY 模式(主机模式): 将真实环境和虚拟环境隔离开, 且仅让虚拟机的系统之间与物理主机通信(桥接都行的), 不能访问外网

4. 产品

   - 连接公网(配置虚拟机采用桥接模式并指定 br0 后): vnet0(虚拟机网卡), br0(桥接交换机), eth0(物理网卡)
     1. 内网出: 数据从虚拟机的网卡 vnet0 发出到 br0, br0 会将数据转发给另一端的 eth0(桥不做中间修改, 只提供连接)
     2. 内网入: 应答回到路由器, 到达物理网卡 eth0(在混杂模式捕获包并交给 br0 处理), 如果是 eth0 的包则宿主机处理; 如果是 vnet0 的包则转发给虚拟机处理(整个过程无需对包做出修改)
     3. 结论: 这样对于内网用户来说是感知不到路由器的存在的, 大家共用路由器的对外 IP 访问公网
   - 连接局域网: dhcp 则可以访问内网

## 路由模式
